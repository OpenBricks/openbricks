#!/bin/sh

. config/options

PERL_CONFIG="$ROOT/$PACKAGES/$1/config/config.sh-${TARGET_ARCH}-${TARGET_LIBC}.in"
if [ ! -r "$PERL_CONFIG" ]; then
  echo "Cannot find a config file for $TARGET_ARCH / $TARGET_LIBC !"
  echo "Perl is not supported on this target, aborting."
  exit 1
fi

# parallel builds usually work, but sometimes they also fail randomly
# better stay on the safe side
export MAKEFLAGS=-j1

# The following black magic has been adapted from the OpenWRT package

cd $BUILD/$1*

# Stage 1: Configure host perl
setup_toolchain host
mkdir -p host-perl
cd host-perl
../Configure -der -Dmksymlinks -Uusedl

# Stage 2: Build host perl binary with static extensions
make
cd ..

# Stage 3: Configure target perl
setup_toolchain target
sed \
  -e "s!%%CC%%!${TARGET_CC}!g" \
  -e "s!%%CFLAGS%%!${TARGET_CFLAGS} -DUSE_CROSS_COMPILE ${TARGET_CPPFLAGS}!g" \
  -e "s!%%CPP%%!${TARGET_CC} -E!g" \
  -e "s!%%AR%%!${TARGET_AR}!g" \
  -e "s!%%LD%%!${TARGET_CC}!g" \
  -e "s!%%LDFLAGS%%!-rdynamic ${TARGET_LDFLAGS}!g" \
  -e "s!%%LIBDIRS%%!${SYSROOT_PREFIX}/lib ${SYSROOT_PREFIX}/usr/lib ${LIB_PREFIX}/lib!g" \
  -e "s!%%INCDIRS%%!${LIB_PREFIX}/include ${SYSROOT_PREFIX}/usr/include!g" \
  $PERL_CONFIG > config.sh
./Configure -S

# Stage 4: Build target miniperl binary
cp -P config.h xconfig.h
rm -f miniperl
make miniperl
mkdir -p target-bin
cp -P miniperl target-bin

# Stage 5: Build target perl binary
rm -f miniperl perl
cp -P host-perl/miniperl .
make perl
cp -P perl target-bin

# Stage 6: Build target extensions and utils
rm -f miniperl perl
cp -P host-perl/miniperl .
ln -sf miniperl perl
make

# Stage 7: Install Perl into staging dir
rm -f perl
cp -P host-perl/perl .
mkdir -p host-perl/.install
./perl installperl --destdir="`pwd`/host-perl/.install"

# Stage 8: Install Perl into a temporary root
rm -f perl
cp -P target-bin/perl .
mkdir -p .install
host-perl/miniperl installperl --destdir="`pwd`/.install"
strip_bins "`pwd`/.install/usr/bin"

# Stage 9: Remove redundant/useless stuff
rm -f .install/usr/bin/perl
ln -sf perl5.10.0 .install/usr/bin/perl
do_perl_strip

exit 0
