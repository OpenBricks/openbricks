#!/bin/sh

. config/options

xbmc_set_option() {
  PKG="$1"
  OPT="$2"
  CFG_LIST="$3"
  pkg_uses $PKG $OPT && CFG=enable || CFG=disable
  for CFG_NAME in $CFG_LIST; do
    EXTRA_CONFIG="$EXTRA_CONFIG --$CFG-$CFG_NAME"
  done
  return 0
}

fix_soname () {
  sed -i "s%@$2_SONAME@%lib$3.so%g" xbmc/DllPaths_generated.h.in
}

xbmc_set_option $1 "opengl"     "gl"
xbmc_set_option $1 "opengles"   "gles"
xbmc_set_option $1 "openmax"    "openmax"
xbmc_set_option $1 "joystick"   "joystick"
xbmc_set_option $1 "faac"       "faac"
xbmc_set_option $1 "zeroconf"   "avahi"
xbmc_set_option $1 "webserver"  "webserver"
xbmc_set_option $1 "vdpau"      "vdpau"
xbmc_set_option $1 "vaapi"      "vaapi"
xbmc_set_option $1 "crystalhd"  "crystalhd"
xbmc_set_option $1 "pulse"      "pulse"
xbmc_set_option $1 "dvdcss"     "dvdcss"
xbmc_set_option $1 "bluray"     "libbluray"
xbmc_set_option $1 "rtmp"       "rtmp"
xbmc_set_option $1 "nonfree"    "non-free"

# check for nVidia ARM Tegra2 optimizations
CFG_TEGRA="--disable-tegra"
[ "$TARGET_PLATFORM" = tegra2 ] && CFG_TEGRA="--enable-tegra"

export LIBS="$LIBS -lstdc++"

cd $BUILD/$1*
touch .dummy.in

# fix libraries runtime .so name lookup
fix_soname $1 BLURAY       bluray
fix_soname $1 CRYSTALHD    crystalhd
fix_soname $1 CURL         curl
fix_soname $1 FAAD         faad
fix_soname $1 FLAC         FLAC
fix_soname $1 MAD          mad
fix_soname $1 MODPLUG      modplug
fix_soname $1 OGG          ogg
fix_soname $1 RTMP         rtmp
fix_soname $1 VORBIS       vorbis
fix_soname $1 VORBISENC    vorbisenc
fix_soname $1 VORBISFILE   vorbisfile

# hack OMAP4 OpenMAX headers check
if [ "$TARGET_PLATFORM" = omap4 ]; then
  sed -i "s%OpenMAX/IL/OMX_Types.h%omx/OMX_Types.h%"            configure
  sed -i "s%I/usr/include/OpenMAX/IL%I$LIB_PREFIX/include/omx%" configure
fi

do_configure \
  --with-arch=$TARGET_ARCH \
  --with-cpu=$TARGET_CPU \
  --disable-debug \
  --disable-optimizations \
  --disable-vdadecoder \
  --disable-profiling \
  --enable-xrandr \
  --disable-goom \
  --disable-ccache \
  --disable-mid \
  --disable-hal \
  --disable-asap-codec \
  --disable-libdts \
  --disable-liba52 \
  --enable-external-ffmpeg \
  --disable-external-liba52 \
  --disable-external-libdts \
  --enable-external-python \
  $CFG_TEGRA \
  $EXTRA_CONFIG \

make externals
make xbmc.bin
make xbmc-xrandr
make_install

exit 0
