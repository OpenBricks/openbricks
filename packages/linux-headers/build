#!/bin/sh

. config/options

$SCRIPTS/unpack linux

[ $TARGET_ARCH = i386 -o $TARGET_ARCH = x86_64 ] && TARGET_ARCH=x86
[ $TARGET_ARCH = powerpc -o $TARGET_ARCH = powerpc64 ] && TARGET_ARCH=powerpc

cd $(kernel_path)
make ARCH=$TARGET_ARCH headers_check
make ARCH=$TARGET_ARCH INSTALL_HDR_PATH=headers headers_install

mkdir -p $ROOT/$BUILD/$1/.install/usr/usr/include
cp -PR headers/include/* $ROOT/$BUILD/$1/.install/usr/usr/include

if [ "$TARGET_PLATFORM" = omap3 -o "$TARGET_PLATFORM" = omap4 ]; then
  mkdir -p $ROOT/$BUILD/$1/.install/usr/usr/include/asm/arch-omap
  cp -PR include/linux/omapfb.h $ROOT/$BUILD/$1/.install/usr/usr/include/asm/arch-omap
  sed -i "s%__user%%g" $ROOT/$BUILD/$1/.install/usr/usr/include/asm/arch-omap/omapfb.h
fi

# boxee requires this deprecated header, let's make it happy
if [ "$TARGET_ARCH" = i386 -o "$TARGET_ARCH" = x86_64 ]; then
  cp -P drivers/staging/smbfs/smbno.h \
    $ROOT/$BUILD/$1/.install/usr/usr/include/linux
fi

exit 0
