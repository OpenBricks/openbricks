#!/bin/sh

. config/options

pkg_uses $1 opengles && CFG_ES=",es"

if [ "$TARGET_ARCH" = i386 -o "$TARGET_ARCH" = x86_64 ]; then
  GALLIUM_STATE_TACKERS="egl,glx$CFG_ES"

  for i in intel radeon svga; do
    GALLIUM_DRIVERS="$GALLIUM_DRIVERS --enable-gallium-$i"
  done
else
  DRI_DRIVERS="--with-dri-drivers=swrast"
  GALLIUM_STATE_TACKERS="egl,glx$CFG_ES"

  for i in intel radeon svga; do
    GALLIUM_DRIVERS="$GALLIUM_DRIVERS --disable-gallium-$i"
  done
fi

# Direct Rendering (DRI)
CFG_DRI="--with-driver=dri $DRI_DRIVERS --with-dri-driverdir=$XORG_PATH_DRI"

# Gallium 3D
CFG_GALLIUM="--enable-gallium --with-state-trackers=$GALLIUM_STATE_TACKERS"
CFG_GALLIUM="$CFG_GALLIUM --enable-gallium-swrast"
CFG_GALLIUM="$CFG_GALLIUM --disable-gallium-nouveau"
CFG_GALLIUM="$CFG_GALLIUM $GALLIUM_DRIVERS"

# EGL: Embedded Graphics Library (native platform graphics interface)
CFG_EGL="--enable-egl --with-egl-driver-dir=$XORG_PATH_EGL"

# X.Org
CFG_XORG="--with-x --with-xorg-driver-dir=$XORG_PATH_DRIVERS"

cd $BUILD/$1*

export HOST_CC=$HOST_CC
export OPT_FLAGS="$CFLAGS"
export HOST_OPT_FLAGS="$HOST_CFLAGS"
export X11_INCLUDES=
export EXTRA_LIB_PATH=
export DRI_DRIVER_INSTALL_DIR="$XORG_PATH_DRI"
export DRI_DRIVER_SEARCH_DIR="$XORG_PATH_DRI"

do_configure \
            --disable-debug \
            --disable-selinux \
            --disable-xcb \
            --enable-glx-tls \
            --enable-driglx-direct \
            --enable-gl-osmesa \
            --enable-glu \
            --enable-glut \
            --disable-glw \
            --disable-motif \
            $CFG_GALLIUM \
            $CFG_DRI \
            $CFG_EGL \
            $CFG_XORG \
            --without-demos \

# dirty hack to build GL Shader Language compiler host tools
make -C src/glsl CC=$HOST_CC CFLAGS="$HOST_CFLAGS" LDFLAGS="$HOST_LDFLAGS"
make -C src/glsl/pp clean
make -C src/glsl/cl clean

# now build Mesa for target
make
make_install

# do some copy for proprietary drivers replacement
MESA_LIB=.install/usr/lib/mesa

mkdir -p $MESA_LIB
cp -P .install/usr/lib/libGL.so*  $MESA_LIB
cp -P .install/usr/lib/libEGL.so* $MESA_LIB

pkg_uses $1 opengles && \
  cp -P .install/usr/lib/libGLES*.so* $MESA_LIB

pkg_uses $1 openvg && \
  cp -PR include/VG .install/usr/include

exit 0

