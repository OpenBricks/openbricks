#!/bin/sh

. config/options

if [ "$TARGET_ARCH" = arm ]; then
  EGL="--enable-egl"
  DRI_DRIVERS="--with-dri-drivers=swrast"
  GALLIUM="--disable-gallium"
else
  EGL="--disable-egl"
  GALLIUM="--enable-gallium"
fi

cd $BUILD/$1*
HOST_CC=$HOST_CC \
OPT_FLAGS="$CFLAGS" \
HOST_OPT_FLAGS="$HOST_CFLAGS" \
X11_INCLUDES= \
DRI_DRIVER_INSTALL_DIR="$XORG_PATH_DRI" \
DRI_DRIVER_SEARCH_DIR="$XORG_PATH_DRI" \
do_configure \
            --disable-debug \
            --disable-selinux \
            --disable-xcb \
            --enable-glx-tls \
            --enable-driglx-direct \
            --enable-gl-osmesa \
            $EGL \
            --enable-glu \
            --disable-glut \
            --disable-glw \
            --disable-motif \
            $GALLIUM \
            --with-driver=dri \
            $DRI_DRIVERS \
            --with-dri-driverdir="$XORG_PATH_DRI" \
            --with-xorg-driver-dir="$XORG_PATH_DRIVERS" \
            --with-x \
            --without-demos \

make
strip_libs lib*
$STRIP src/mesa/libmesa*.so*
make_install
mkdir -p .install/usr/lib/mesa
cp -P .install/usr/lib/libGL.so* .install/usr/lib/mesa/
