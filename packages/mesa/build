#!/bin/sh

. config/options

cd $BUILD/$1*

export HOST_CC=$HOST_CC
export OPT_FLAGS="$CFLAGS"
export HOST_OPT_FLAGS="$HOST_CFLAGS"
export X11_INCLUDES=
export EXTRA_LIB_PATH=
export DRI_DRIVER_INSTALL_DIR="$XORG_PATH_DRI"
export DRI_DRIVER_SEARCH_DIR="$XORG_PATH_DRI"

# DRI: Direct Rendering Interface
pkg_uses $1 intel     && DRI_DRIVERS="${DRI_DRIVERS}i915,i965,"
pkg_uses $1 radeon    && DRI_DRIVERS="${DRI_DRIVERS}r200,r300,r600,radeon,"
pkg_uses $1 nouveau   && DRI_DRIVERS="${DRI_DRIVERS}nouveau,"
pkg_uses $1 r128      && DRI_DRIVERS="${DRI_DRIVERS}r128,"
pkg_uses $1 savage    && DRI_DRIVERS="${DRI_DRIVERS}savage,"
pkg_uses $1 mga       && DRI_DRIVERS="${DRI_DRIVERS}mga,"
pkg_uses $1 tdfx      && DRI_DRIVERS="${DRI_DRIVERS}tdfx,"
pkg_uses $1 unichrome && DRI_DRIVERS="${DRI_DRIVERS}unichrome,"
pkg_uses $1 sis       && DRI_DRIVERS="${DRI_DRIVERS}sis,"
pkg_uses $1 mach64    && DRI_DRIVERS="${DRI_DRIVERS}mach64,"
DRI_DRIVERS="${DRI_DRIVERS}swrast"

# Gallium 3D
GALLIUM_EGL="--disable-gallium-egl"
GALLIUM_OVG="--disable-openvg"
if pkg_uses $1 gallium3d; then
  pkg_uses $1 radeon  && GALLIUM_DRIVERS="${GALLIUM_DRIVERS}r600,"
  pkg_uses $1 nouveau && GALLIUM_DRIVERS="${GALLIUM_DRIVERS}nouveau,"
  GALLIUM_DRIVERS="${GALLIUM_DRIVERS}swrast"
  GALLIUM_EGL="--enable-gallium-egl"
  GALLIUM_OVG="--enable-openvg"
fi

# EGL: Embedded Graphics Library (native platform graphics interface)
EGL_DISPLAYS="x11,drm"

GCC_NO_GOLD=1 GCC_NO_LTO=1 \
do_configure \
  --disable-debug \
  --disable-selinux \
  --enable-glx-tls \
  --enable-xcb \
  --with-driver=dri \
  --with-dri-drivers="$DRI_DRIVERS" \
  --with-dri-driverdir="$XORG_PATH_DRI" \
  --with-egl-platforms="$EGL_DISPLAYS" \
  --with-egl-driver-dir="$XORG_PATH_EGL" \
  --with-xorg-driver-dir="$XORG_PATH_DRIVERS" \
  --with-gallium-drivers="$GALLIUM_DRIVERS" \
  --with-state-trackers=egl,glx,dri,vega \
  --disable-gallium-llvm \
  $GALLIUM_EGL \
  --enable-opengl \
  --enable-gles-overlay \
  --enable-gles1 \
  --enable-gles2 \
  $GALLIUM_OVG \
  --enable-shared-glapi \
  --enable-shared-dricore \
  --enable-driglx-direct \
  --enable-glu \
  --disable-gl-osmesa \
  --disable-glut \
  --disable-glw \
  --disable-motif \

# now build Mesa for target
make
make_install

# do some copy for proprietary drivers replacement
MESA_LIB=.install/usr/lib/mesa

mkdir -p $MESA_LIB
cp -P .install/usr/lib/libGL.so*      $MESA_LIB
cp -P .install/usr/lib/libEGL.so*     $MESA_LIB
cp -P .install/usr/lib/libGLES*.so*   $MESA_LIB
[ -f .install/usr/lib/libOpenVG*.so ] && \
  cp -P .install/usr/lib/libOpenVG*.so* $MESA_LIB

exit 0

