#!/bin/sh

. config/options

if pkg_uses $1 opengles; then
  CFG_GLES="--enable-gles1 --enable-gles2 --enable-gles-overlay"
else
  CFG_GLES="--disable-gles1 --disable-gles2 --disable-gles-overlay"
fi

if pkg_uses $1 openvg; then
  CFG_GALLIUM_VG=",vega"
  CFG_OVG="--enable-openvg"
fi

if pkg_uses $1 egl; then
  # EGL: Embedded Graphics Library (native platform graphics interface)
  CFG_GALLIUM_EGL="egl,"
  CFG_EGL="--enable-egl --with-egl-driver-dir=$XORG_PATH_EGL"
else
  CFG_EGL="--disable-egl"
fi

if pkg_uses $1 intel; then
  DRI_DRIVERS="${DRI_DRIVERS}i915,i965,"
  GALLIUM_DRIVERS="$GALLIUM_DRIVERS --enable-gallium-i915 --enable-gallium-i965"
else
  GALLIUM_DRIVERS="$GALLIUM_DRIVERS --disable-gallium-i915 --disable-gallium-i965"
fi

if pkg_uses $1 radeon; then
  DRI_DRIVERS="${DRI_DRIVERS}r200,r300,r600,radeon,"
  GALLIUM_DRIVERS="$GALLIUM_DRIVERS --enable-gallium-radeon --enable-gallium-r600"
else
  GALLIUM_DRIVERS="$GALLIUM_DRIVERS --disable-gallium-radeon --disable-gallium-r600"
fi

if pkg_uses $1 nouveau; then
  GALLIUM_DRIVERS="$GALLIUM_DRIVERS --enable-gallium-nouveau"
else
  GALLIUM_DRIVERS="$GALLIUM_DRIVERS --disable-gallium-nouveau"
fi

if pkg_uses $1 vmwgfx; then
  GALLIUM_DRIVERS="$GALLIUM_DRIVERS --enable-gallium-svga"
else
  GALLIUM_DRIVERS="$GALLIUM_DRIVERS --disable-gallium-svga"
fi

pkg_uses $1 r128      && DRI_DRIVERS="${DRI_DRIVERS}r128,"
pkg_uses $1 savage    && DRI_DRIVERS="${DRI_DRIVERS}savage,"
pkg_uses $1 mga       && DRI_DRIVERS="${DRI_DRIVERS}mga,"
pkg_uses $1 tdfx      && DRI_DRIVERS="${DRI_DRIVERS}tdfx,"
pkg_uses $1 unichrome && DRI_DRIVERS="${DRI_DRIVERS}unichrome,"
pkg_uses $1 sis       && DRI_DRIVERS="${DRI_DRIVERS}sis,"
pkg_uses $1 mach64    && DRI_DRIVERS="${DRI_DRIVERS}mach64,"

CFG_GALLIUM="$CFG_GALLIUM --enable-gallium-swrast"
DRI_DRIVERS="${DRI_DRIVERS}swrast,"
CFG_GALLIUM_DRI="dri,xorg,"

GALLIUM_STATE_TACKERS="${CFG_GALLIUM_EGL}${CFG_GALLIUM_DRI}glx${CFG_GALLIUM_GLES}${CFG_GALLIUM_VG}"

# Direct Rendering (DRI)
CFG_DRI="--with-driver=dri --with-dri-drivers=$DRI_DRIVERS --with-dri-driverdir=$XORG_PATH_DRI"

# Gallium 3D
CFG_GALLIUM="--enable-gallium --with-state-trackers=$GALLIUM_STATE_TACKERS"
CFG_GALLIUM="$CFG_GALLIUM --disable-gallium-llvm"
CFG_GALLIUM="$CFG_GALLIUM $GALLIUM_DRIVERS"

# X.Org
CFG_XORG="--with-x --with-xorg-driver-dir=$XORG_PATH_DRIVERS"

cd $BUILD/$1*

export HOST_CC=$HOST_CC
export OPT_FLAGS="$CFLAGS"
export HOST_OPT_FLAGS="$HOST_CFLAGS"
export X11_INCLUDES=
export EXTRA_LIB_PATH=
export DRI_DRIVER_INSTALL_DIR="$XORG_PATH_DRI"
export DRI_DRIVER_SEARCH_DIR="$XORG_PATH_DRI"

do_configure \
            --disable-debug \
            --disable-selinux \
            --disable-xcb \
            --enable-glx-tls \
            --enable-driglx-direct \
            --enable-gl-osmesa \
            --enable-glu \
            --enable-glut \
            --disable-glw \
            --disable-motif \
            $CFG_GLES \
            $CFG_GALLIUM \
            $CFG_DRI \
            $CFG_EGL \
            $CFG_XORG \
            $CFG_OVG \

# now build Mesa for target
make
make_install

# do some copy for proprietary drivers replacement
MESA_LIB=.install/usr/lib/mesa

mkdir -p $MESA_LIB
cp -P .install/usr/lib/libGL.so*  $MESA_LIB

pkg_uses $1 egl && \
  cp -P .install/usr/lib/libEGL.so* $MESA_LIB

pkg_uses $1 opengles && \
  cp -P .install/usr/lib/libGLES*.so* $MESA_LIB

pkg_uses $1 openvg && \
  cp -P .install/usr/lib/libOpenVG*.so* $MESA_LIB

exit 0

