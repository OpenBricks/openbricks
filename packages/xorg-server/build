#!/bin/sh

. config/options

$SCRIPTS/unpack mesa

get_meta $1

if [ -d $ROOT/$BUILD/$1-$PKG_VERSION/debian/patches ] ; then
  while read i ; do
    if [ -f  $ROOT/$BUILD/$1-$PKG_VERSION//debian/patches/$i ] ; then 
      apply_patch $1 $ROOT/$BUILD/$1-$PKG_VERSION/debian/patches/$i
    fi
  done < $ROOT/$BUILD/$1-$PKG_VERSION/debian/patches/series
fi

cd $BUILD/$1*

do_autoconf

# xorg-server needs some mesa includes to build
get_meta mesa
MESA_DIR="$ROOT/$BUILD/$PKG_NAME-$PKG_VERSION"
export local_cppflags="-I$MESA_DIR/include"
export GL_CFLAGS="-I$MESA_DIR/include"
export GL_LIBS=" "
export DRI_CFLAGS="-I$LIB_PREFIX/include"
export DRI_LIBS=" "
sed -i 's%dridriverdir=`$PKG_CONFIG --variable=dridriverdir dri`%dridriverdir=/usr/lib/dri%' configure

export LIBS="-ludev"
GCC_NO_GOLD=1 GCC_NO_LTO=1 \
do_configure \
            --enable-largefile \
            --disable-strict-compilation \
            --disable-debug \
            --disable-docs \
            --disable-devel-docs \
            --without-doxygen \
            --without-fop \
            --without-xmlto \
            --without-dtrace \
            --disable-install-libxf86config \
            --enable-mitshm \
            --enable-aiglx \
            --enable-glx-tls \
            --enable-registry \
            --enable-composite \
            --enable-xres \
            --enable-record \
            --enable-xv \
            --enable-xvmc \
            --enable-dga \
            --enable-screensaver \
            --disable-xdmcp \
            --disable-xdm-auth-1 \
            --enable-glx \
            --enable-dri \
            --enable-dri2 \
            --enable-gestures \
            --enable-xinerama \
            --enable-xf86vidmode \
            --enable-xace \
            --disable-xselinux \
            --enable-xcsecurity \
            --disable-xcalibrate \
            --disable-tslib \
            --enable-dbe \
            --disable-xf86bigfont \
            --enable-dpms \
            --disable-config-dbus \
            --enable-config-udev \
            --disable-config-hal \
            --enable-xfree86-utils \
            --enable-xorg \
            --disable-dmx \
            --enable-xvfb \
            --disable-xnest \
            --disable-xquartz \
            --disable-standalone-xpbproxy \
            --disable-xwin \
            --disable-kdrive \
            --disable-xephyr \
            --disable-xfake \
            --enable-xfbdev \
            --disable-install-setuid \
            --disable-secure-rpc \
            --disable-ipv6 \
            --with-os-vendor="OpenBricks" \
            --with-int10=x86emu \
            --with-module-dir=$XORG_PATH_MODULES \
            --with-xkb-path=$XORG_PATH_XKB \
            --with-xkb-output=$XORG_PATH_XKB_CACHE \
            --with-log-dir=/var/log \
            --with-fontrootdir=$XORG_PATH_FONTS \
            --with-default-font-path="$XORG_PATH_FONTS/misc,built-ins" \
            --with-sha1=libgcrypt \

make V=1
make_install
mkdir -p .install/usr/lib/mesa
cp -P .install/$XORG_PATH_MODULES/extensions/libglx.so .install/usr/lib/mesa
