#!/bin/sh

. config/options

require_glibc $1

if [ "$TARGET_ARCH" = i386 ]; then
  ARCH=x86
elif [ "$TARGET_ARCH" = x86_64 ]; then
  ARCH=x86_64
else
  echo "$1 is compiled only for i386 or x86_64, exiting."
  exit 1
fi

$SCRIPTS/build linux

cd $BUILD/$1*/common/lib/modules/fglrx/build_mod
sed -i -e 's/__SMP__/CONFIG_SMP/' *.c *h
sed -i -e 's/ifdef MODVERSIONS/ifdef CONFIG_MODVERSIONS/' *.c *.h

ln -sf \
  $ROOT/$BUILD/$1*/arch/$ARCH/lib/modules/fglrx/build_mod/libfglrx_ip.a.GCC4 .

cd 2.6.x
make CC=${CC} \
    KDIR=$(kernel_path) \
    KVER=2.6.38 \
    GCC_VER_MAJ=4

cd ../../../../..
