#!/bin/sh

. config/options

require_glibc $1

if [ "$TARGET_ARCH" = i386 ]; then
  ARCH=x86
  LIBDIR=lib
  BASEDIR=x750
elif [ "$TARGET_ARCH" = x86_64 ]; then
  ARCH=x86_64
  LIBDIR=lib64
  BASEDIR=x750_64a
else
  echo "$1 is compiled only for i386 or x86_64, exiting."
  exit 1
fi

XORG_DST="$INSTALL/$XORG_PATH_MODULES"

# ATI kernel driver
mkdir -p "$INSTALL/lib/modules/$(kernel_version)/kernel/drivers/video"
cp $BUILD/$1*/common/lib/modules/fglrx/build_mod/2.6.x/fglrx.ko \
  $INSTALL/lib/modules/*/kernel/drivers/video

# X.Org modules
for dir in . drivers linux; do
  mkdir -p $XORG_DST/$dir
  cp $BUILD/$1*/$BASEDIR/usr/X11R6/$LIBDIR/modules/$dir/*.so $XORG_DST/$dir
done

# DRI driver
mkdir -p $INSTALL/usr/lib/dri
cp $BUILD/$1*/arch/$ARCH/usr/X11R6/$LIBDIR/modules/dri/fglrx_dri.so* \
  $INSTALL/usr/lib/dri

# Ati's libGL has an hardcoded location for DRI modules
mkdir -p $INSTALL/usr/X11R6/$LIBDIR/modules/
ln -sf /usr/lib/dri $INSTALL/usr/X11R6/$LIBDIR/modules/dri

# System Libs
mkdir -p $INSTALL/usr/lib
cp $BUILD/$1*/arch/$ARCH/usr/$LIBDIR/libati*.so* $INSTALL/usr/lib
cp $BUILD/$1*/arch/$ARCH/usr/X11R6/$LIBDIR/libati*.so* $INSTALL/usr/lib
cp $BUILD/$1*/arch/$ARCH/usr/X11R6/$LIBDIR/libfglrx*.so* $INSTALL/usr/lib
cp $BUILD/$1*/arch/$ARCH/usr/X11R6/$LIBDIR/lib*XvBA*.so* $INSTALL/usr/lib
cp $BUILD/$1*/arch/$ARCH/usr/X11R6/$LIBDIR/libAMDXvBA.cap $INSTALL/usr/lib

# OpenGL libs
mkdir -p $INSTALL/usr/lib/fglrx
cp $BUILD/$1*/arch/$ARCH/usr/X11R6/$LIBDIR/libGL.so* \
  $INSTALL/usr/lib/fglrx/libGL.so.1
cp $BUILD/$1*/$BASEDIR/usr/X11R6/$LIBDIR/modules/extensions/libglx.so* \
  $INSTALL/usr/lib/fglrx/libglx.so

mkdir -p $INSTALL/etc
cat >> $INSTALL/etc/video <<EOF
# Enable Xorg non-free binary drivers
BINARY_DRIVERS=yes
EOF

exit 0
