#!/bin/sh

# Adapted from dracut shutdown module

do_umount() {
  local ret=1
  while read a mp a; do
    if [ "`echo $mp | cut -f2 -d/`" = "oldroot" ]; then
      if umount "$mp"; then
        ret=0
        echo "Unmounted $mp."
      fi
    fi
  done < /proc/mounts

  return $ret
}

export PATH=/sbin:/bin

# install busybox symlinks
busybox --install -s

count=0
while [ $count -le 40 ]; do
  do_umount 2>/dev/null || break
  count=$(($count+1))
done
[ $count -ge 40 ] && do_umount

# "Clean" umount of /oldroot
mount -o remount,ro,del=/oldroot/.squashfs /oldroot
umount /dev/loop0
mkdir /fake_br
mount -o remount,rw,prepend=/fake_br /oldroot
mount -o remount,mod=/oldroot/.data=ro /oldroot      # Now we can't write in branche
mount -o remount,ro,noxino /oldroot /oldroot
mount -o remount,ro /oldroot/.data                   # Now we can't write in /oldroot/.data
mkdir /data                                          # Preparing for lazy umount of aufs
mount --move /oldroot/.data /data
umount -l /oldroot
umount /data                                         # Umount cleanly /data
cat /proc/mounts                                     # Just to see ...

case "$1" in
  reboot) reboot -f; break;;
  halt) halt -f; break;;
  poweroff) poweroff -f; break;;
esac

# this should never happen
sh
