#!/bin/sh

. config/options

$SCRIPTS/build linux

# build system doesn't cope well with parall make
export MAKEFLAGS=-j1

cd $BUILD/$1*/wlan/platforms/os/linux

make \
  CROSS_COMPILE="$TARGET_PREFIX" \
  AR=ar \
  ARCH="$TARGET_ARCH" \
  HOST_PLATFORM=sdc4430 \
  KERNEL_DIR=$(kernel_path) \
  KVERSION=$(kernel_version) \
  WPASUPPL_DIR="`ls -d $ROOT/$BUILD/$1*`" \
  BUILD_SUPPL=y \

install_dir="$PWD/.install"
debug_dir="$PWD/.install-debuginfo/usr/lib/debug"
kmod_dir="$install_dir/lib/modules/$(kernel_version)"

mkdir -p $kmod_dir/kernel/drivers/net/wireless/tiwlan-wl1271
cp -P tiwlan_drv.ko $kmod_dir/kernel/drivers/net/wireless/tiwlan-wl1271
strip_kmods "$kmod_dir" "$debug_dir"

mkdir -p $install_dir/usr/bin
cp -P tiwlan_loader $install_dir/usr/bin
cp -P wlan_cu $install_dir/usr/bin
strip_bins "$install_dir" "$debug_dir"

mkdir -p $install_dir/firmware/tiwlan-wl1271
cp -P tiwlan.ini $install_dir/firmware/tiwlan-wl1271
cp -P tiwlan_dual.ini $install_dir/firmware/tiwlan-wl1271
