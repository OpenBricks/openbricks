#!/bin/sh

. config/options

# image
mkdir -p $INSTALL/boot
case $TARGET_ARCH in
  arm)
    cp $BUILD/$1*/arch/$TARGET_ARCH/boot/uImage $INSTALL/boot/uImage
    BOOT_CFG="$ROOT/$CONFIG/platforms/arm/$TARGET_PLATFORM/boot.cfg"
    if [ -f "$BOOT_CFG" ]; then
       cp $BOOT_CFG $INSTALL/boot/boot.cfg
       [ -n "$REMOTE" ] && \
         sed -i s%remote=default_remote%remote=$REMOTE% \
           $INSTALL/boot/boot.cfg
       [ -n "$RECEIVER" ] && \
         sed -i s%receiver=default_receiver%receiver=$RECEIVER% \
           $INSTALL/boot/boot.cfg
       mkimage -A arm -O u-boot -T script -C none \
        -n "GeeXboX Boot" -d $INSTALL/boot/boot.cfg $INSTALL/boot/boot.ini
       rm -f $INSTALL/boot/boot.cfg
    fi
    ;;
  i386|x86_64)
    cp $BUILD/$1*/arch/$TARGET_ARCH/boot/bzImage $INSTALL/boot/vmlinuz
    ;;
  powerpc)
    cp $BUILD/$1*/vmlinux $INSTALL/boot/vmlinux
    $STRIP $INSTALL/boot/vmlinux
    ;;
  powerpc64)
    cp $BUILD/$1*/arch/powerpc/boot/zImage $INSTALL/boot/zImage
    $STRIP $INSTALL/boot/zImage
    ;;
esac

# copy kernel drivers
mkdir -p $INSTALL/lib/modules/$(kernel_version)
cp -r $BUILD/$1*/modules/* $INSTALL

# copy kernel firmwares (if present)
rm -rf $INSTALL/lib/firmware
mkdir -p $INSTALL/firmware
if [ -d $BUILD/$1*/modules/lib/firmware ]; then
  cp -rf $BUILD/$1*/modules/lib/firmware/* $INSTALL/firmware
else
  echo "No firmware"
fi

# config
mkdir -p $INSTALL/sbin
cp $PACKAGES/$1/scripts/setup_tvcard_options $INSTALL/sbin

mkdir -p $INSTALL/etc
cp $PACKAGES/$1/config/modules $INSTALL/etc
cp $PACKAGES/$1/config/tvcard $INSTALL/etc
cp $PACKAGES/$1/config/pvr $INSTALL/etc

mkdir -p $INSTALL/etc/modprobe.d
cp $PACKAGES/$1/config/tv.conf $INSTALL/etc/modprobe.d
