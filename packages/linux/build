#!/bin/sh

. config/options

unset LDFLAGS

cd $(kernel_path)
rm -rf modules
mkdir -p modules

case $TARGET_ARCH in
  i386|x86_64)  IMAGE=bzImage  ;;
  mips|powerpc) IMAGE=vmlinux  ;;
  powerpc64)    IMAGE=zImage   ;;
  arm)          IMAGE=uImage   ;;
esac
make $IMAGE
make modules
make INSTALL_MOD_PATH=modules DEPMOD=$ROOT/$TOOLCHAIN/bin/depmod modules_install
rm -f modules/lib/modules/*/build
rm -f modules/lib/modules/*/source

if [ "$TARGET_ARCH" = arm ]; then
  BOOT_CFG="$ROOT/$CONFIG/platforms/arm/$TARGET_PLATFORM/boot.cfg"
  if [ -f "$BOOT_CFG" ]; then
     cp $BOOT_CFG boot.cfg
     [ -n "$REMOTE" ] && \
       sed -i s%remote=default_remote%remote=$REMOTE% boot.cfg
     [ -n "$RECEIVER" ] && \
       sed -i s%receiver=default_receiver%receiver=$RECEIVER% boot.cfg
     [ -n "$KEYMAP" ] && \
       sed -i s%keymap=qwerty%keymap=$KEYMAP% boot.cfg
     mkimage -A arm -O u-boot -T script -C none \
      -n "GeeXboX Boot" -d boot.cfg boot.ini
     rm -f boot.cfg
  fi
fi
