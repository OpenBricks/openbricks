#!/bin/sh

. config/options

unset LDFLAGS

cd $(kernel_path)

case $TARGET_ARCH in
  i386|x86_64)  IMAGE=bzImage  ;;
  mips|powerpc) IMAGE=vmlinux  ;;
  powerpc64)    IMAGE=zImage   ;;
  arm)          IMAGE=uImage   ;;
esac
make $IMAGE
make modules

install_dir="`pwd`/.install"
debug_dir="`pwd`/.install-debuginfo/usr/lib/debug"
rm -rf $install_dir $debug_dir
mkdir -p $install_dir $debug_dir

make modules_install \
  INSTALL_MOD_PATH=.install \
  DEPMOD=$ROOT/$TOOLCHAIN/bin/depmod \

kmod_dir="$install_dir/lib/modules/$(kernel_version)"

mv .install/lib/firmware .install/firmware
rm -f $kmod_dir/build $kmod_dir/source $kmod_dir/modules.*
strip_kmods "$kmod_dir" "$debug_dir"
