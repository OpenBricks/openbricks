#!/bin/sh

. config/options

$SCRIPTS/build genext2fs
$SCRIPTS/install lzma

export INSTALL=$BUILD/$1/mnt

rm -rf $INSTALL
mkdir -p $INSTALL
rm -f $BUILD/$1/$1 $BUILD/$1/$1.gz

mkdir $INSTALL/bin
mkdir $INSTALL/etc
mkdir $INSTALL/ramfs
mkdir $INSTALL/sbin
mkdir $INSTALL/usr
mkdir $INSTALL/usr/bin

$SCRIPTS/install $TARGET_LIBC
$SCRIPTS/install busybox
$SCRIPTS/install udev
$SCRIPTS/install iscd

cp $PACKAGES/$1/scripts/linuxrc $INSTALL
cp $PACKAGES/$1/scripts/console $INSTALL/sbin
cp $PACKAGES/$1/scripts/nosystem $INSTALL/sbin
cp $PACKAGES/$1/scripts/r[ow] $INSTALL/usr/bin

ln -s /bin/busybox $INSTALL/bin/sh
echo $TARGET_ARCH > $INSTALL/etc/arch

$BUILD/genext2fs*/genext2fs -d $INSTALL -b $RAMDISK_SIZE -i 512 $BUILD/$1/$1

if [ $TARGET_ARCH = powerpc ]; then
  gzip -9 $BUILD/$1/$1
else
  lzma e $BUILD/$1/$1 $BUILD/$1/$1.gz
fi
