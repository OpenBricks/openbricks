>From dabbfb2070c1223b8b439334eea4613d6328219b Mon Sep 17 00:00:00 2001
From: Davide Cavalca <davide@geexbox.org>
Date: Sun, 16 Jan 2011 10:40:58 +0100
Subject: [PATCH 2/4] syslogd: conditional systemd support


Signed-off-by: Davide Cavalca <davide@geexbox.org>
---
 libbb/Kbuild.src    |    2 ++
 sysklogd/Config.src |    8 ++++++++
 sysklogd/syslogd.c  |    8 ++++++++
 3 files changed, 18 insertions(+), 0 deletions(-)

diff --git a/libbb/Kbuild.src b/libbb/Kbuild.src
index 0fa1451..119e0ad 100644
--- a/libbb/Kbuild.src
+++ b/libbb/Kbuild.src
@@ -160,6 +160,8 @@ lib-$(CONFIG_IOSTAT) += get_cpu_count.o
 lib-$(CONFIG_MPSTAT) += get_cpu_count.o
 lib-$(CONFIG_POWERTOP) += get_cpu_count.o
 
+lib-$(CONFIG_FEATURE_SYSLOGD_SYSTEMD) += sd-daemon.o
+
 # We shouldn't build xregcomp.c if we don't need it - this ensures we don't
 # require regex.h to be in the include dir even if we don't need it thereby
 # allowing us to build busybox even if uclibc regex support is disabled.
diff --git a/sysklogd/Config.src b/sysklogd/Config.src
index 1e59872..a9af225 100644
--- a/sysklogd/Config.src
+++ b/sysklogd/Config.src
@@ -22,6 +22,14 @@ config SYSLOGD
 	  wrong. And something almost always will go wrong if
 	  you wait long enough....
 
+config FEATURE_SYSLOGD_SYSTEMD
+	bool "Enable systemd socket activation support"
+	default n
+	depends on SYSLOGD && PLATFORM_LINUX
+	help
+	  This makes syslogd compliant to the systemd's New-Style Daemons
+	  guidelines and implements socket-based activation.
+
 config FEATURE_ROTATE_LOGFILE
 	bool "Rotate message files"
 	default y
diff --git a/sysklogd/syslogd.c b/sysklogd/syslogd.c
index fb73095..1837413 100644
--- a/sysklogd/syslogd.c
+++ b/sysklogd/syslogd.c
@@ -34,6 +34,9 @@
 #include <sys/shm.h>
 #endif
 
+#if ENABLE_FEATURE_SYSLOGD_SYSTEMD
+#include "sd-daemon.h"
+#endif
 
 #define DEBUG 0
 
@@ -512,6 +515,11 @@ static NOINLINE int create_socket(void)
 	int sock_fd;
 	char *dev_log_name;
 
+#if ENABLE_FEATURE_SYSLOGD_SYSTEMD
+	if ((sock_fd = xsystemd_unix_socket("/dev/log")) != -1)
+		return sock_fd;
+#endif
+	
 	memset(&sunx, 0, sizeof(sunx));
 	sunx.sun_family = AF_UNIX;
 
-- 
1.7.2.3

