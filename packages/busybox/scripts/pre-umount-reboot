#!/bin/sh

if grep -q external-persistent /proc/cmdline; then
  for f in `ls  /.data/ | grep -v root | grep -v mnt | grep -v data` ; do
    cp -R /.data/$f /persistent/
  done
  umount /persistent
  umount /data
fi

while read i ; do 
  umount `echo $i | cut -d" " -f1`
done < /var/mnts 

while read i ; do 
  a=`echo $i | grep "/mnt/shares/"| cut -d" " -f2`
  [ -n "$a" ] && umount $a 
done < /proc/mounts

systemctl reboot
