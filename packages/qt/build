#!/bin/sh

. config/options

require_cxx $1

# architecture specific options
case "$TARGET_ARCH" in
  i386|x86_64)
    CROSS_ARCH=x86
    CROSS_ENDIAN="-little-endian"
    CROSS_GL="-opengl"
    CROSS_VG="-no-openvg"
    ;;

  powerpc|powerpc64)
    CROSS_ARCH=powerpc
    CROSS_ENDIAN="-big-endian"
    CROSS_GL="-opengl"
    CROSS_VG="-no-openvg"
    ;;

  arm)
    CROSS_ARCH=arm
    CROSS_ENDIAN="-little-endian"
    CROSS_GL="-opengl es2"
    CROSS_VG="-no-openvg"
    ;;
esac

if pkg_uses $1 webkit; then
    CFG_WEBKIT="-webkit"
    CFG_JS="-javascript-jit"
else
    CFG_WEBKIT="-no-webkit"
    CFG_JS="-no-javascript-jit"
fi

cd $BUILD/$1*

# unset flags, QT does it by itself
unset CC CXX AR OBJCOPY STRIP CFLAGS CXXFLAGS CPPFLAGS LDFLAGS

# force our pkg-config usage
export QT_FORCE_PKGCONFIG=yes

yes | ./configure \
            -opensource \
            -release \
            -prefix         /usr \
            -sysconfdir     /etc \
            -datadir        /usr/share/qt4 \
            -plugindir      /usr/share/qt4/translations \
            -translationdir /usr/lib/qt4/plugins \
            -crossarch $CROSS_ARCH \
            $CROSS_ENDIAN \
            -platform linux-g++ \
            -xplatform linux-g++-geexbox \
            -shared \
            -no-qt3support \
            $CROSS_GL \
            $CROSS_VG \
            $CFG_WEBKIT \
            $CFG_JS \
            -declarative \
            -no-openssl \
            -no-nis \
            -no-cups \
            -make libs \
            -make tools \
            -nomake examples \
            -nomake demos \
            -nomake docs \
            -v

./bin/qmake
make

make_install

# discard native system includes
sed -i "s%-I/usr/include%%g" .install/usr/lib/*.la
sed -i "s%-L/usr/lib%%g"     .install/usr/lib/*.la
sed -i "s%-I/usr/include%%g" .install/usr/lib/*.prl
sed -i "s%-L/usr/lib%%g"     .install/usr/lib/*.prl
sed -i "s%-I/usr/include%%g" .install/usr/lib/pkgconfig/*.pc
sed -i "s%-L/usr/lib%%g"     .install/usr/lib/pkgconfig/*.pc
