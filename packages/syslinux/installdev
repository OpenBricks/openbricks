#!/bin/sh

. config/options

mkdir -p $INSTALL/share/syslinux
cp $BUILD/$1*/core/ldlinux.sys $INSTALL/share/syslinux
cp $BUILD/$1*/core/ldlinux.bss $INSTALL/share/syslinux
cp $BUILD/$1*/mbr/mbr.bin $INSTALL/share/syslinux

mkdir -p $INSTALL/boot/pxelinux.cfg
cp $BUILD/$1*/core/isolinux.bin $INSTALL/boot
if [ -n "$BOOT_DEFAULT" ]; then
  grep -v ".*MENU DEFAULT$" $PACKAGES/$1/config/isolinux.cfg > $INSTALL/boot/isolinux.cfg
  sed -i "s%\(.*\)\(LABEL $BOOT_DEFAULT\)$%\1\2\n\1  MENU DEFAULT%" $INSTALL/boot/isolinux.cfg
else
  cp $PACKAGES/$1/config/isolinux.cfg $INSTALL/boot
fi
[ "$CONSOLE" = yes ] && SDTV_PARAMS="^#SD#" || SDTV_PARAMS="^#SD#.*"
sed -i s%$SDTV_PARAMS%% $INSTALL/boot/isolinux.cfg
#[ "$XORG" = yes ] && HDTV_PARAMS="^#HD#" || HDTV_PARAMS="^#HD#.*"
HDTV_PARAMS="^#HD#"
sed -i s%$HDTV_PARAMS%% $INSTALL/boot/isolinux.cfg
if [ "$INSTALLATOR" = "yes" ]; then
  [ "$TARGET_ARCH" = i386 ] && INS_PARAMS="^#INS#" || INS_PARAMS="^#INS#.*"
  sed -i s%$INS_PARAMS%% $INSTALL/boot/isolinux.cfg
fi
CFG_PARAMS="^#CFG#"
sed -i s%$CFG_PARAMS%% $INSTALL/boot/isolinux.cfg
sed -i s%remote=default_remote%remote=$REMOTE% $INSTALL/boot/isolinux.cfg
sed -i s%receiver=default_receiver%receiver=$RECEIVER% $INSTALL/boot/isolinux.cfg
sed -i s%keymap=qwerty%keymap=$KEYMAP% $INSTALL/boot/isolinux.cfg
sed -i s%lang=en%lang=$MENU_LANG% $INSTALL/boot/isolinux.cfg
sed -i s%extra_cmdline_params%$EXTRA_CMDLINE_PARAMS% $INSTALL/boot/isolinux.cfg
cp $PACKAGES/$1/config/help.msg $INSTALL/boot
cp $BUILD/$1*/core/pxelinux.0 $INSTALL/boot
sed -i s%target-arch%$TARGET_ARCH% $INSTALL/boot/isolinux.cfg
sed -i s%release-nr%$DISTRO_VERSION% $INSTALL/boot/isolinux.cfg

cp $INSTALL/boot/isolinux.cfg $INSTALL/boot/pxelinux.cfg/default

cp $BUILD/$1*/com32/menu/vesamenu.c32 $INSTALL/boot
cp $PACKAGES/$1/config/splash.png $INSTALL/boot
