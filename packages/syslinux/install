#!/bin/sh

. config/options

get_vesa_resolutions () {
#  Table for the Kernel mode numbers is:
# 
#     | 640x480  800x600  1024x768 1280x1024
# ----+-------------------------------------
# 256 |  0x301    0x303    0x305    0x307   
# 32k |  0x310    0x313    0x316    0x319   
# 64k |  0x311    0x314    0x317    0x31A   
# 16M |  0x312    0x315    0x318    0x31B
#
  case "$RESOLUTION" in
    640x480)
      VESA=786
      ;;
    800x600)
      VESA=789
      ;;
    1024x768)
      VESA=792
      ;;
    1280x1024)
      VESA=795
      ;;
    *) # defaults to 800x600
      VESA=789
      ;;
  esac
  [ "$VMWARE" = yes ] && VESA=$(($VESA-1))
  return 0
}

case "$2" in
  binary)
    mkdir -p $INSTALL/usr/bin
    mkdir -p $INSTALL/usr/share
    cp $BUILD/$1*/mtools/$1 $INSTALL/usr/bin
    cp $BUILD/$1*/ldlinux.sys $INSTALL/usr/share
    ;;

  *)
    mkdir -p $INSTALL/boot/pxelinux.cfg
    cp $BUILD/$1*/isolinux.bin $INSTALL/boot
    if [ -n "$BOOT_DEFAULT" ]; then
      grep -v ".*MENU DEFAULT$" $PACKAGES/$1/config/isolinux.cfg > $INSTALL/boot/isolinux.cfg
      sed -i "s%\(.*\)\(LABEL $BOOT_DEFAULT\)$%\1\2\n\1  MENU DEFAULT%" $INSTALL/boot/isolinux.cfg
    else
      cp $PACKAGES/$1/config/isolinux.cfg $INSTALL/boot
    fi
    [ "$CONSOLE" = yes ] && SDTV_PARAMS="^#SD#" || SDTV_PARAMS="^#SD#.*"
    sed -i s%$SDTV_PARAMS%% $INSTALL/boot/isolinux.cfg
    [ "$XORG" = yes ] && HDTV_PARAMS="^#HD#" || HDTV_PARAMS="^#HD#.*"
    sed -i s%$HDTV_PARAMS%% $INSTALL/boot/isolinux.cfg
    sed -i s%remote=default_remote%remote=$REMOTE% $INSTALL/boot/isolinux.cfg
    sed -i s%receiver=default_receiver%receiver=$RECEIVER% $INSTALL/boot/isolinux.cfg
    sed -i s%keymap=qwerty%keymap=$KEYMAP% $INSTALL/boot/isolinux.cfg
    sed -i s%lang=en%lang=$MENU_LANG% $INSTALL/boot/isolinux.cfg
    cp $PACKAGES/$1/config/help.msg $INSTALL/boot
    cp $BUILD/$1*/pxelinux.0 $INSTALL/boot
    get_vesa_resolutions
    sed -i "s/vga=789/vga=$VESA/g" $INSTALL/boot/isolinux.cfg
    sed -i s%target-arch%$TARGET_ARCH% $INSTALL/boot/isolinux.cfg
    sed -i s%release-nr%$GEEXBOX_VERSION% $INSTALL/boot/isolinux.cfg
    sed "s/boot=[^ ]*/boot=nfs/" $INSTALL/boot/isolinux.cfg > $INSTALL/boot/pxelinux.cfg/default

    if [ "$DEFAULT_PXE" = nfs ]; then
      sed -i "s%\(.*APPEND.*\)%\1 nfsroot=$DEFAULT_NFS_SERVER:$DEFAULT_NFS_DIR.$VERSION_SUFFIX%" $INSTALL/boot/pxelinux.cfg/default
    else
      sed -i "s%\(.*APPEND.*\)%\1 smbroot=//$DEFAULT_SMB_SERVER/$DEFAULT_SMB_DIR smbuser=\"$DEFAULT_SMB_USER\" \"$DEFAULT_SMB_PWD\"%" $INSTALL/boot/pxelinux.cfg/default
    fi

    cp $BUILD/$1*/com32/menu/vesamenu.c32 $INSTALL/boot
    if [ "$2" != generator ]; then
      $SCRIPTS/unpack theme-$THEME
      [ -f $BUILD/theme-$THEME/splash.png ] && cp $BUILD/theme-$THEME/splash.png $INSTALL/boot
    fi
    ;;
esac

exit 0
