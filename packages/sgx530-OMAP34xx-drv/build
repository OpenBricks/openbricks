#!/bin/sh

. config/options

$SCRIPTS/unpack linux

cd $BUILD/$1*

# fix pvr_drm.h build
cp services4/include/env/linux/pvr_drm_shared.h services4/srvkm/env/linux

# build drivers
make BUILD=release TI_PLATFORM=omap3630 KERNELDIR=$(kernel_path) SUPPORT_XORG=1

install_dir="$PWD/.install"
debug_dir="$PWD/.install-debuginfo/usr/lib/debug"
kmod_dir="$install_dir/lib/modules/$(kernel_version)"

mkdir -p $kmod_dir/kernel/drivers/gpu/pvr $debug_dir
cp -P \
  pvrsrvkm.ko \
  services4/3rdparty/dc_omap3430_linux/omaplfb.ko \
  services4/3rdparty/bufferclass_ti/bufferclass_ti.ko \
  $kmod_dir/kernel/drivers/gpu/pvr

strip_kmods "$kmod_dir" "$debug_dir"
