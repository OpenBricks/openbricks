#!/bin/sh

. config/path

KCONFIG="`ls -d $BUILD_NOARCH/kconfig-frontends-*`/.config"

if [ ! -f "$KCONFIG" ]; then
  echo "Cannot find .config, aborting."
  exit 1
fi

cat > build/config/options <<EOF
############################################
# This file is autogenerated, do not edit! #
############################################

EOF

# take the CONFIG_OPT_ options, remove the prefix and add to build/config/options
grep -E '^CONFIG_OPT_' $KCONFIG | sed s/^CONFIG_OPT_// | uniq >> build/config/options
grep -E '^CONFIG_USE_' $KCONFIG | sed s/^CONFIG_// | uniq >> build/config/options

# convert =y/=n to =yes/=no
sed -i -e 's/^\(.*\)=y/\1=yes/' -e 's/^\(.*\)=n/\1=no/' build/config/options

# packages to be installed to rootfs
PKG_YES=`grep -E '^CONFIG_PKG_.*=y' $KCONFIG | sed 's/^CONFIG_PKG_\(.*\)=y/\1/' | xargs`

echo "ROOTFS_PACKAGES=\"$PKG_YES\"" >> build/config/options

# packages to be only built as opk
PKG_MOD=`grep -E '^CONFIG_PKG_.*=m' $KCONFIG | sed 's/^CONFIG_PKG_\(.*\)=m/\1/' | xargs`

echo "OPK_PACKAGES=\"$PKG_MOD\"" >> build/config/options

# enable overlay
grep 'CONFIG_OVERLAY_OPENBRICKS_OPTIONS=y' $KCONFIG && \
  echo 'test -f "$HOME/.openbricks-options" && . "$HOME/.openbricks-options"' \
    >> build/config/options

exit 0
